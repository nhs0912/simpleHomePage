/**
 * Created by sgjeon on 16. 4. 8..
 */

const _ = require('lodash');

module.exports = function(grunt, options){

    const config = grunt.config.get('config');
    const path = require("path");
    const nodeModulesPath = path.join(config.tools.path.root, 'node_modules');
    const webpackConfigPath = path.join(__dirname, '../../webpack');

    const shell = {
        webpack: {
            command: [
                'cd ' + webpackConfigPath,
                'node ' + path.join(nodeModulesPath, 'webpack/bin/webpack.js ') + '-b ' + '<%=config.env %>'
            ].join('&&')
        }
    };

    (function initShells() {

        var userTaskPreDev = [];
        var userTaskPostDev = [];

        var userTaskPreProd = [];
        var userTaskPostProd = [];

        const userTask = config.build.userTask;

        if (_.isPlainObject(userTask)){

            if (_.isPlainObject(userTask.pre)) {
                userTaskPreDev = _.isArray(userTask.pre.dev) ? userTask.pre.dev : [];
                userTaskPreProd = _.isArray(userTask.pre.prod) ? userTask.pre.prod : [];
            }

            if (_.isPlainObject(userTask.post)) {
                userTaskPostDev = _.isArray(userTask.post.dev) ? userTask.post.dev : [];
                userTaskPostProd = _.isArray(userTask.post.prod) ? userTask.post.prod : [];
            }
        }

        shell.userTaskPreDev = userTaskPreDev.join('&&');
        shell.userTaskPreProd = userTaskPreProd.join('&&');

        shell.userTaskPostDev = userTaskPostDev.join('&&');
        shell.userTaskPostProd = userTaskPostProd.join('&&');
    })();

    return shell;
};
